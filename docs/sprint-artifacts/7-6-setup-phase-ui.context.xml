<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>7</epicId>
    <storyId>6</storyId>
    <title>초기 배치 UI</title>
    <status>drafted</status>
    <generatedAt>2025-12-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/7-6-setup-phase-ui.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>플레이어</asA>
    <iWant>게임 시작 시 초기 정착지와 도로를 배치할 수 있어</iWant>
    <soThat>카탄 규칙에 맞는 완전한 게임 플레이 가능</soThat>
    <tasks>
      <task id="1" ac="7-6.1">GameState setup 구조체 구현
        <subtask id="1.1">GameState:new()에서 mode = "setup" 초기화</subtask>
        <subtask id="1.2">setup 구조체 초기화 (round, direction, phase, currentPlayer)</subtask>
        <subtask id="1.3">GameState:isSetup() 헬퍼 함수</subtask>
      </task>
      <task id="2" ac="7-6.3, 7-6.4, 7-6.5, 7-6.6">advanceSetup() 상태 전이 로직
        <subtask id="2.1">settlement → road 페이즈 전환</subtask>
        <subtask id="2.2">road → 다음 플레이어 전환 (forward)</subtask>
        <subtask id="2.3">Round 1 → Round 2 전환 (direction = "reverse")</subtask>
        <subtask id="2.4">Round 2 완료 → mode = "playing" 전환</subtask>
      </task>
      <task id="3" ac="7-6.1, 7-6.2, 7-6.3">Setup UI 표시
        <subtask id="3.1">setup 모드 안내 텍스트 표시 ("Player X: Place Settlement/Road")</subtask>
        <subtask id="3.2">액션 버튼 숨김 (setup 모드에서는 버튼 불필요)</subtask>
        <subtask id="3.3">현재 라운드/플레이어 정보 표시</subtask>
      </task>
      <task id="4" ac="7-6.2">Setup 정착지 배치 연동
        <subtask id="4.1">setup 모드에서 유효 정점 계산 (isInitialPlacement = true)</subtask>
        <subtask id="4.2">정점 클릭 시 Actions.buildSettlementFree() 호출</subtask>
        <subtask id="4.3">마지막 배치 정착지 위치 저장 (도로 연결용)</subtask>
        <subtask id="4.4">배치 성공 후 setup.phase = "road"</subtask>
      </task>
      <task id="5" ac="7-6.3">Setup 도로 배치 연동
        <subtask id="5.1">마지막 정착지 인접 변만 유효 위치로 필터링</subtask>
        <subtask id="5.2">변 클릭 시 Actions.buildRoadFree() 호출</subtask>
        <subtask id="5.3">배치 성공 후 advanceSetup() 호출</subtask>
      </task>
      <task id="6" ac="7-6.5">Round 2 자원 지급
        <subtask id="6.1">Round 2 정착지 배치 시 인접 타일 확인</subtask>
        <subtask id="6.2">각 인접 타일의 자원 1개씩 플레이어에게 지급</subtask>
        <subtask id="6.3">사막 타일은 자원 없음 처리</subtask>
      </task>
      <task id="7" ac="All">테스트 및 검증
        <subtask id="7.1">2인/3인/4인 게임 각각 setup 순서 확인</subtask>
        <subtask id="7.2">Round 1 → Round 2 전환 확인</subtask>
        <subtask id="7.3">Round 2 자원 지급 확인</subtask>
        <subtask id="7.4">setup 완료 후 playing 모드 전환 확인</subtask>
        <subtask id="7.5">전체 게임 플로우 테스트 (setup → roll → build → end turn)</subtask>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="7-6.1" title="Setup 모드 진입">
      <check>새 게임 시작 시 mode = "setup"</check>
      <check>setup.round = 1, setup.direction = "forward"</check>
      <check>setup.currentPlayer = 1, setup.phase = "settlement"</check>
      <check>"Player X: Place Settlement" 안내 표시</check>
    </criterion>
    <criterion id="7-6.2" title="정착지 배치 (Setup)">
      <check>유효한 정점 하이라이트 (distance rule 적용, 연결 규칙 무시)</check>
      <check>정점 클릭 시 Actions.buildSettlementFree() 실행</check>
      <check>배치 성공 후 setup.phase = "road"로 전환</check>
      <check>"Player X: Place Road" 안내 표시</check>
    </criterion>
    <criterion id="7-6.3" title="도로 배치 (Setup)">
      <check>방금 배치한 정착지에 연결된 변만 하이라이트</check>
      <check>변 클릭 시 Actions.buildRoadFree() 실행</check>
      <check>배치 성공 후 advanceSetup() 호출</check>
    </criterion>
    <criterion id="7-6.4" title="Snake Draft 순서 (Round 1)">
      <check>Round 1: 플레이어 1 → 2 → 3 → 4 순서</check>
      <check>각 플레이어: 정착지 1개 + 도로 1개 배치</check>
      <check>플레이어 4 완료 시 Round 2 시작</check>
    </criterion>
    <criterion id="7-6.5" title="Snake Draft 순서 (Round 2)">
      <check>Round 2: 플레이어 4 → 3 → 2 → 1 역순</check>
      <check>각 플레이어: 정착지 1개 + 도로 1개 배치</check>
      <check>두 번째 정착지 인접 타일 자원 지급</check>
    </criterion>
    <criterion id="7-6.6" title="Setup 완료 및 Playing 전환">
      <check>플레이어 1의 Round 2 배치 완료 시</check>
      <check>mode = "playing", turn.current = 1, phase = "roll"</check>
      <check>일반 게임 플로우 시작</check>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-7.md</path>
        <title>Epic 7 Technical Specification</title>
        <section>Setup Mode State Transition (Snake Draft)</section>
        <snippet>Setup 모드 상태 전이 로직: settlement → road 페이즈 전환, Round 1 Forward (1→2→3→4), Round 2 Reverse (4→3→2→1), Round 2 완료 시 mode = "playing"으로 전환</snippet>
      </doc>
      <doc>
        <path>docs/sprint-artifacts/tech-spec-epic-7.md</path>
        <title>Epic 7 Technical Specification</title>
        <section>GameState 구조</section>
        <snippet>setup 구조체: round (1 또는 2), direction ("forward" | "reverse"), phase ("settlement" | "road"), currentPlayer (1-based)</snippet>
      </doc>
      <doc>
        <path>docs/game-architecture.md</path>
        <title>Game Architecture</title>
        <section>Data Architecture - GameState 구조</section>
        <snippet>게임 상태 통합 구조: mode ("setup" | "playing" | "finished"), turn 관리, 플레이어/보드 상태</snippet>
      </doc>
    </docs>
    <code>
      <file>
        <path>src/game/game_state.lua</path>
        <kind>module</kind>
        <symbol>GameState</symbol>
        <lines>1-end</lines>
        <reason>setup 구조체 추가, advanceSetup() 메서드 구현, isSetup() 헬퍼 필요</reason>
      </file>
      <file>
        <path>src/game/actions.lua</path>
        <kind>module</kind>
        <symbol>Actions.buildSettlementFree</symbol>
        <lines>137-154</lines>
        <reason>Setup 모드에서 무료 정착지 배치에 사용</reason>
      </file>
      <file>
        <path>src/game/actions.lua</path>
        <kind>module</kind>
        <symbol>Actions.buildRoadFree</symbol>
        <lines>165-182</lines>
        <reason>Setup 모드에서 무료 도로 배치에 사용</reason>
      </file>
      <file>
        <path>src/game/rules.lua</path>
        <kind>module</kind>
        <symbol>Rules.getValidSettlementLocations</symbol>
        <lines>190-233</lines>
        <reason>Setup 모드에서 isInitialPlacement=true로 호출하여 유효 정점 계산</reason>
      </file>
      <file>
        <path>src/game/rules.lua</path>
        <kind>module</kind>
        <symbol>Rules.canBuildInitialRoad</symbol>
        <lines>336-355</lines>
        <reason>Setup 도로 배치 시 정착지 인접 변 검증</reason>
      </file>
      <file>
        <path>src/game/rules.lua</path>
        <kind>module</kind>
        <symbol>Rules.getInitialResources</symbol>
        <lines>310-326</lines>
        <reason>Round 2 정착지 배치 시 인접 타일 자원 지급</reason>
      </file>
      <file>
        <path>src/scenes/game.lua</path>
        <kind>scene</kind>
        <symbol>game</symbol>
        <lines>1-end</lines>
        <reason>Setup UI 통합: 안내 텍스트, 버튼 숨김, 정점/변 클릭 핸들링</reason>
      </file>
      <file>
        <path>tests/game/game_state_spec.lua</path>
        <kind>test</kind>
        <symbol>describe("GameState")</symbol>
        <lines>1-end</lines>
        <reason>setup 모드 테스트 추가: Snake Draft 순서, 상태 전이, 자원 지급</reason>
      </file>
    </code>
    <dependencies>
      <lua>
        <package name="love2d" version="11.5+" purpose="Game engine"/>
        <package name="busted" version="latest" purpose="TDD testing framework"/>
        <package name="classic" version="latest" purpose="Class system"/>
        <package name="hump.gamestate" version="latest" purpose="Scene management"/>
      </lua>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="pattern">게임 로직(src/game/)과 렌더링(src/ui/, src/scenes/)을 분리하여 TDD 가능하게 유지</constraint>
    <constraint type="layer">setup 구조체는 mode = "setup"에서만 의미 있음, turn 구조체는 mode = "playing"에서만 사용</constraint>
    <constraint type="naming">파일명: snake_case, 클래스: PascalCase, 함수: camelCase</constraint>
    <constraint type="testing">모든 src/game/ 모듈은 busted 테스트 먼저 작성 (TDD)</constraint>
    <constraint type="coordinate">정점은 정규화된 (q, r, dir) 형식 사용, Map 키는 "q,r,dir" 문자열</constraint>
  </constraints>

  <interfaces>
    <interface name="GameState:advanceSetup" kind="method" path="src/game/game_state.lua">
      <signature>function GameState:advanceSetup() -> void</signature>
      <description>Setup 모드에서 다음 단계로 진행: settlement→road, 다음 플레이어, Round 전환, playing 모드 전환</description>
    </interface>
    <interface name="GameState:isSetup" kind="method" path="src/game/game_state.lua">
      <signature>function GameState:isSetup() -> boolean</signature>
      <description>현재 mode가 "setup"인지 확인</description>
    </interface>
    <interface name="GameState:getSetupPlayer" kind="method" path="src/game/game_state.lua">
      <signature>function GameState:getSetupPlayer() -> number</signature>
      <description>Setup 모드에서 현재 배치할 플레이어 ID 반환</description>
    </interface>
    <interface name="GameState:getSetupPhase" kind="method" path="src/game/game_state.lua">
      <signature>function GameState:getSetupPhase() -> string</signature>
      <description>Setup 모드에서 현재 페이즈 ("settlement" | "road") 반환</description>
    </interface>
    <interface name="Actions.buildSettlementFree" kind="function" path="src/game/actions.lua">
      <signature>function Actions.buildSettlementFree(game, playerId, vertex) -> boolean, string?</signature>
      <description>자원 소모 없이 정착지 배치 (초기 배치용)</description>
    </interface>
    <interface name="Actions.buildRoadFree" kind="function" path="src/game/actions.lua">
      <signature>function Actions.buildRoadFree(game, playerId, edge) -> boolean, string?</signature>
      <description>자원 소모 없이 도로 배치 (초기 배치용)</description>
    </interface>
    <interface name="Rules.getValidSettlementLocations" kind="function" path="src/game/rules.lua">
      <signature>function Rules.getValidSettlementLocations(board, playerId, isInitialPlacement) -> table</signature>
      <description>건설 가능한 정점 목록 반환. isInitialPlacement=true면 연결 규칙 무시, 거리 규칙만 적용</description>
    </interface>
    <interface name="Rules.canBuildInitialRoad" kind="function" path="src/game/rules.lua">
      <signature>function Rules.canBuildInitialRoad(board, playerId, edge, settlement) -> boolean</signature>
      <description>초기 배치 시 도로가 정착지에 인접한지 확인</description>
    </interface>
    <interface name="Rules.getInitialResources" kind="function" path="src/game/rules.lua">
      <signature>function Rules.getInitialResources(board, vertex) -> table</signature>
      <description>정점 인접 타일의 자원 반환 (Round 2 자원 지급용)</description>
    </interface>
  </interfaces>

  <tests>
    <standards>busted 프레임워크 사용, BDD 스타일 (describe/it), before_each로 setup, Arrange-Act-Assert 패턴</standards>
    <locations>
      <location>tests/game/game_state_spec.lua</location>
      <location>tests/game/*.lua</location>
    </locations>
    <ideas>
      <idea ac="7-6.1">GameState.new()에서 mode="setup", setup 구조체 초기화 검증</idea>
      <idea ac="7-6.1">GameState:isSetup()이 mode="setup"일 때 true 반환</idea>
      <idea ac="7-6.2">settlement 페이즈에서 advanceSetup() 호출 시 road 페이즈로 전환</idea>
      <idea ac="7-6.3">road 페이즈에서 advanceSetup() 호출 시 다음 플레이어로 전환</idea>
      <idea ac="7-6.4">4인 게임 Round 1: 플레이어 1→2→3→4 순서 검증</idea>
      <idea ac="7-6.4">플레이어 4 도로 배치 후 Round 2, direction="reverse" 전환 검증</idea>
      <idea ac="7-6.5">4인 게임 Round 2: 플레이어 4→3→2→1 순서 검증</idea>
      <idea ac="7-6.5">Round 2 정착지 배치 시 Rules.getInitialResources() 호출 및 자원 지급 검증</idea>
      <idea ac="7-6.6">플레이어 1 Round 2 도로 배치 후 mode="playing", turn.current=1, phase="roll" 전환 검증</idea>
      <idea ac="7-6.4, 7-6.5">2인, 3인 게임에서 Snake Draft 순서 검증</idea>
    </ideas>
  </tests>
</story-context>
