# Epic 4 Retrospective: Board State

**Date:** 2025-12-01
**Facilitator:** BMad (Scrum Master)
**Epic Duration:** 2 days (2025-11-30 ~ 2025-12-01)
**Stories Completed:** 4/4 (100%)

---

## Epic Summary

Epic 4 구현 완료. 게임 보드 상태 관리 기능 전체 구현.

| Story | Title | Status | Tests Added |
|-------|-------|--------|-------------|
| 4-1 | 보드 타일 생성 | ✅ done | 14 |
| 4-2 | 숫자 토큰 배치 | ✅ done | 9 |
| 4-3 | 정착지/도시 배치 | ✅ done | 31 |
| 4-4 | 도로 배치 | ✅ done | 24 |

**Total Tests:** 200 (78 new in Epic 4)
**Test Pass Rate:** 100%

---

## What Went Well

### 1. TDD Approach (테스트 주도 개발)
- 모든 스토리에서 테스트 우선 작성 후 구현
- 회귀 테스트 덕분에 기존 기능 안전하게 보존
- 78개 새 테스트로 Epic 4 기능 완전 커버

### 2. Pattern Consistency (패턴 일관성)
- **ADR-003 Map 기반 저장**: tiles, settlements, cities, roads 모두 동일 패턴
- **정규화 패턴**: Vertex.normalize, Edge.normalize 일관되게 적용
- **키 생성 헬퍼**: tileKey, vertexKey, edgeKey 동일한 "q,r,dir" 형식
- **API 반환 패턴**: (boolean, error_message) 에러 처리 일관성

### 3. Incremental Development (점진적 개발)
- Story 4-1에서 Board 기본 구조 확립 → 후속 스토리에서 확장
- 각 스토리가 이전 스토리 위에 자연스럽게 쌓임
- createTilePool → createNumberPool 패턴 재사용

### 4. Code Review Quality (코드 리뷰 품질)
- Senior Developer Review (AI)로 모든 AC/Task 체계적 검증
- 누락된 구현 없이 100% 완성도 달성
- 아키텍처 준수 확인 (ADR-001, ADR-003)

---

## Lessons Learned

### 1. Circular Dependency Prevention (순환 의존성 방지)
**Issue:** Story 4-4에서 Vertex.getAdjacentEdges 구현 시 Edge 모듈 의존 필요

**Solution:** 함수 내부에서 require 호출
```lua
function Vertex.getAdjacentEdges(q, r, dir)
  local Edge = require("src.game.edge")  -- 함수 내부 require
  -- ...
end
```

**Learning:** 상호 의존이 필요한 경우 함수 레벨에서 lazy require로 해결 가능

### 2. Vertex Normalization Impact (정점 정규화 영향)
**Issue:** Story 4-4 테스트 실패 - S 정점이 N으로 정규화되어 예상 인접 변이 달라짐

**Solution:** 테스트에서 정규화 후 실제 인접 관계로 수정
- (0,0,S) → (0,1,N)으로 정규화됨
- S 정점의 인접 변 ≠ N 정점의 인접 변

**Learning:** 정규화 시스템 사용 시 테스트도 정규화 결과 기준으로 작성

### 3. Tile Vertex Mapping (타일-정점 매핑)
**Issue:** getSettlementsOnTile/getCitiesOnTile에서 타일 인접 정점 6개 계산 복잡

**Solution:** 명시적 정점 목록으로 해결
```lua
local vertices = {
  {q = q, r = r, dir = "N"},
  {q = q, r = r, dir = "S"},
  {q = q, r = r - 1, dir = "S"},
  {q = q + 1, r = r - 1, dir = "S"},
  {q = q + 1, r = r, dir = "N"},
  {q = q - 1, r = r + 1, dir = "N"}
}
```

**Learning:** 헥스 기하학 관계는 하드코딩이 계산보다 명확할 수 있음

### 4. Code Review Thoroughness (코드 리뷰 철저함)
**Observation:** 모든 스토리에서 Task Completion Validation 100% 달성

**Learning:** Task 체크박스 + AI 리뷰 조합으로 누락 방지 효과적

---

## Technical Debt Identified

### 1. Number Token Placement Rules (숫자 토큰 배치 규칙)
**Location:** Story 4-2 TODO 섹션
**Issue:** 현재 단순 랜덤 셔플, 공식 카탄 규칙 미적용
- 6과 8이 인접 타일에 배치되지 않아야 함
- 동일 숫자가 인접하지 않아야 함

**Priority:** Low (게임플레이에 큰 영향 없음)
**Recommendation:** Epic 7 이후 품질 개선 시 구현

### 2. Duplicate Vertex List in Tile Queries (타일 쿼리 정점 목록 중복)
**Location:** board.lua getSettlementsOnTile, getCitiesOnTile
**Issue:** 동일한 6개 정점 목록이 두 함수에 중복

**Priority:** Low (기능 정상 동작)
**Recommendation:** 헬퍼 함수로 추출 가능하나 현재 코드가 명확함

---

## Metrics

| Metric | Value |
|--------|-------|
| Stories Completed | 4 |
| Tests Added | 78 |
| Total Test Count | 200 |
| Files Created | 2 (board.lua, board_spec.lua) |
| Files Modified | 4 (constants.lua, vertex.lua, edge.lua, vertex_spec.lua) |
| Code Review Issues | 0 HIGH, 0 MEDIUM, 2 LOW (advisory) |
| Architecture Violations | 0 |

---

## Recommendations for Next Epic

### Epic 5: Game Rules

**Key Observations:**
- Epic 4에서 확립된 Board API (placeSettlement, placeRoad, etc.)를 Epic 5 규칙 검증에서 활용
- isVertexConnectedToRoad가 Story 5-3 건설 가능 위치 검증에 직접 사용됨
- getSettlementsOnTile, getCitiesOnTile이 Story 5-2 자원 분배에 필요

**Preparation Needed:**
1. Epic 5 Tech Context 생성 필요 (현재 backlog)
2. rules.lua 모듈 신규 생성 예정
3. dice.lua 모듈 신규 생성 예정
4. actions.lua 모듈 신규 생성 예정

**Pattern Suggestions:**
- canBuildSettlement, canBuildRoad 검증 함수는 Board 메서드가 아닌 rules.lua에 분리
- 자원 분배 로직은 Board와 Player 모듈 조합으로 구현
- 초기 배치 페이즈는 별도 상태 플래그로 연결 규칙 무시 처리

---

## Team Acknowledgments

**Contributors:**
- BMad (AI Scrum Master): 워크플로우 진행, 코드 리뷰
- Claude Opus 4.5 (Dev Agent): 구현 및 테스트 작성

**Special Notes:**
- Epic 3의 Vertex/Edge 정규화 시스템이 Epic 4 구현을 크게 단순화함
- 일관된 테스트 패턴으로 디버깅 시간 최소화

---

## Conclusion

Epic 4 "Board State"가 성공적으로 완료되었습니다. 19개 타일 보드 생성, 숫자 토큰 배치, 정착지/도시/도로 배치 및 조회 기능이 모두 구현되었으며, 200개 테스트로 품질이 보장됩니다.

다음 단계는 Epic 5 "Game Rules"로, 주사위 굴림, 자원 분배, 건설 규칙 검증, 승리 조건 체크를 구현합니다.

---

_Generated by BMAD Retrospective Workflow_
_Epic 4 Board State - Complete_
